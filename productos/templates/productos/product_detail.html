{% extends "coimpres_cuba/base.html" %}
{% load static %}

{% block title %}{{ object.name }} | Coimpres Cuba{% endblock %}

{% block content %}
<div class="container my-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'productos:product_list' %}">Productos</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ object.name }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-6 mb-4">
            {% if object.image %}
                <img src="{{ object.image.url }}" class="img-fluid rounded" alt="{{ object.name }}">
            {% else %}
                <img src="{% static 'img/no-image.jpg' %}" class="img-fluid rounded" alt="Sin imagen">
            {% endif %}
            
            {% if object.video_url %}
            <div class="mt-3">
                <h5>Video del producto:</h5>
                <div class="ratio ratio-16x9">
                    <iframe src="{{ object.video_url }}" allowfullscreen></iframe>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-md-6">
            <h1 class="mb-3">{{ object.name }}</h1>
            
            {% if object.proveedor %}
            <div class="mb-3">
                <h5>Proveedor:</h5>
                <p>{{ object.proveedor.name }}</p>
                {% if object.proveedor.logo %}
                    <img src="{{ object.proveedor.logo.url }}" alt="{{ object.proveedor.name }}" class="img-fluid" style="max-height: 50px;">
                {% endif %}
            </div>
            {% endif %}
            
            {% if object.price %}
            <div class="mb-3">
                <h3>Precio: ${{ object.price }}</h3>
            </div>
            {% endif %}
            
            {% if object.short_description %}
            <div class="mb-3">
                <h5>Descripción corta:</h5>
                <p>{{ object.short_description }}</p>
            </div>
            {% endif %}
            
            {% if object.sku %}
            <div class="mb-3">
                <h5>Código SKU:</h5>
                <p>{{ object.sku }}</p>
            </div>
            {% endif %}
            
            <div class="mb-3">
                <h5>Categoría:</h5>
                <p><span class="category-badge">{{ object.category }}</span></p>
                {% if object.subcategory %}
                    <h5>Subcategoría:</h5>
                    <p><span class="badge bg-secondary">{{ object.subcategory.name }}</span></p>
                {% endif %}
                
                {% if object.status_procedencia %}
                <h5 class="mt-3">Disponibilidad:</h5>
                <p><span class="badge {% if object.status_procedencia.name == 'En stock' %}bg-success{% elif object.status_procedencia.name == 'Por pedido' %}bg-warning text-dark{% else %}bg-info{% endif %}">
                    {{ object.status_procedencia.name }}
                </span></p>
                {% endif %}
            </div>
            
            <div class="mb-4">
                <a href="https://wa.me/+5399999999?text=Hola, estoy interesado en el producto {{ object.name }}" class="btn btn-whatsapp btn-lg">
                    <i class="bi bi-whatsapp"></i> Contactar por WhatsApp
                </a>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="true">Descripción</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="specs-tab" data-bs-toggle="tab" data-bs-target="#specs" type="button" role="tab" aria-controls="specs" aria-selected="false">Especificaciones</button>
                </li>
            </ul>
            <div class="tab-content p-4 border border-top-0 rounded-bottom" id="productTabsContent">
                <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
                    {% if object.description %}
                        {{ object.description|linebreaks }}
                    {% else %}
                        <p>No hay descripción detallada disponible para este producto.</p>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="specs" role="tabpanel" aria-labelledby="specs-tab">
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                {% if object.origen %}
                                <tr>
                                    <th scope="row">País de origen</th>
                                    <td>{{ object.origen }}</td>
                                </tr>
                                {% endif %}
                                {% if object.peso %}
                                <tr>
                                    <th scope="row">Peso</th>
                                    <td>{{ object.peso }} kg</td>
                                </tr>
                                {% endif %}
                                {% if object.status_procedencia %}
                                <tr>
                                    <th scope="row">Status de procedencia</th>
                                    <td>{{ object.status_procedencia }}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if object.ficha_tecnica %}
                    <div class="mt-3">
                        <a href="{{ object.ficha_tecnica.url }}" class="btn btn-outline-primary" target="_blank">
                            <i class="bi bi-file-earmark-pdf"></i> Descargar ficha técnica
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Productos relacionados en carrusel -->
    {% if related_products %}
    <div class="related-products-section mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">Productos relacionados</h3>
            <div class="d-none d-md-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm related-prev" aria-label="Anterior">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm related-next" aria-label="Siguiente">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
        <div class="related-carousel-wrapper position-relative">
            <div class="related-carousel-track" data-items="{{ related_products|length }}">
                {% for related_product in related_products %}
                <div class="related-item">
                    <div class="related-card h-100">
                        <div class="related-image-wrapper">
                            {% if related_product.image %}
                                <img src="{{ related_product.image.url }}" alt="{{ related_product.name }}" loading="lazy">
                            {% else %}
                                <img src="{% static 'img/no-image.jpg' %}" alt="Sin imagen" loading="lazy">
                            {% endif %}
                            <div class="related-overlay">
                                <a href="{% url 'productos:product_detail' related_product.slug %}" class="btn btn-sm btn-light fw-semibold shadow-sm">Ver detalle</a>
                            </div>
                        </div>
                        <div class="p-3">
                            <h6 class="mb-1 text-truncate" title="{{ related_product.name }}">{{ related_product.name }}</h6>
                            <p class="small text-muted mb-2 text-truncate" title="{{ related_product.short_description }}">{{ related_product.short_description|default:""|truncatechars:70 }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                {% if related_product.price %}
                                <span class="price-tag">${{ related_product.price }}</span>
                                {% else %}
                                <span class="small text-muted">Consultar</span>
                                {% endif %}
                                <a href="{% url 'productos:product_detail' related_product.slug %}" class="stretched-link d-inline-block ms-2 text-accent small">→</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- Controles móviles -->
            <button class="btn btn-outline-secondary btn-sm related-prev mobile-control" aria-label="Anterior">
                <i class="bi bi-chevron-left"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm related-next mobile-control" aria-label="Siguiente">
                <i class="bi bi-chevron-right"></i>
            </button>
            <div class="fade-edge left"></div>
            <div class="fade-edge right"></div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Carrusel simple para productos relacionados
document.addEventListener('DOMContentLoaded', function() {
  const track = document.querySelector('.related-carousel-track');
  if(!track) return;
  const prevButtons = document.querySelectorAll('.related-prev');
  const nextButtons = document.querySelectorAll('.related-next');
  const itemWidth = () => track.querySelector('.related-item')?.getBoundingClientRect().width || 260;
  const scrollAmount = () => itemWidth() * (window.innerWidth < 576 ? 1 : 2.5);

  function scroll(dir) {
    track.scrollBy({ left: dir * scrollAmount(), behavior: 'smooth'});
  }
  prevButtons.forEach(btn => btn.addEventListener('click', () => scroll(-1)));
  nextButtons.forEach(btn => btn.addEventListener('click', () => scroll(1)));

  // Drag / swipe
  let isDown = false, startX, scrollLeft;
  track.addEventListener('mousedown', (e) => { isDown = true; track.classList.add('grabbing'); startX = e.pageX - track.offsetLeft; scrollLeft = track.scrollLeft; });
  track.addEventListener('mouseleave', () => { isDown = false; track.classList.remove('grabbing'); });
  track.addEventListener('mouseup', () => { isDown = false; track.classList.remove('grabbing'); });
  track.addEventListener('mousemove', (e) => { if(!isDown) return; e.preventDefault(); const x = e.pageX - track.offsetLeft; const walk = (x - startX) * 1.2; track.scrollLeft = scrollLeft - walk; });

  // Touch
  let touchStartX = 0, touchScrollLeft = 0;
  track.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; touchScrollLeft = track.scrollLeft; }, {passive:true});
  track.addEventListener('touchmove', (e) => { const dx = e.touches[0].clientX - touchStartX; track.scrollLeft = touchScrollLeft - dx; }, {passive:true});

    // ===== Autoplay (rotación automática) =====
    let autoplayDelay = 4000; // ms
    let autoplayTimer = null;
    let userPausedUntil = 0;

    function atEnd() {
        return track.scrollLeft + track.clientWidth >= track.scrollWidth - 5; // margen de tolerancia
    }

    function doAutoplayStep() {
        // Si el usuario pausó recientemente, respetar pausa
        if(Date.now() < userPausedUntil) return;
        if(atEnd()) {
            track.scrollTo({ left: 0, behavior: 'smooth' });
        } else {
            track.scrollBy({ left: scrollAmount(), behavior: 'smooth' });
        }
    }

    function startAutoplay() {
        stopAutoplay();
        autoplayTimer = setInterval(doAutoplayStep, autoplayDelay);
    }
    function stopAutoplay() { if(autoplayTimer) { clearInterval(autoplayTimer); autoplayTimer = null; } }

    // Pausar cuando el usuario interactúa (hover, focus, drag, botones)
    function pauseAfterUserAction(extra = 8000) { // pausa extendida
        userPausedUntil = Date.now() + extra;
        // Reiniciar inmediatamente el temporizador para que respete nueva pausa
        startAutoplay();
    }

    // Eventos de interacción
    ['mouseenter','focusin','touchstart'].forEach(evt => {
        track.addEventListener(evt, () => { stopAutoplay(); });
    });
    ['mouseleave','focusout','touchend'].forEach(evt => {
        track.addEventListener(evt, () => { pauseAfterUserAction(); });
    });
    prevButtons.forEach(btn => btn.addEventListener('click', () => pauseAfterUserAction()));
    nextButtons.forEach(btn => btn.addEventListener('click', () => pauseAfterUserAction()));
    track.addEventListener('mousedown', () => pauseAfterUserAction());
    track.addEventListener('mouseup', () => pauseAfterUserAction());

    // Iniciar autoplay
    startAutoplay();
});
</script>
<style>
/* Carrusel de productos relacionados */
.related-products-section { position: relative; }
.related-carousel-wrapper { position: relative; }
.related-carousel-track { display: flex; gap: 1rem; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth; padding: .25rem .25rem 1rem .25rem; }
.related-carousel-track::-webkit-scrollbar { display: none; }
.related-item { flex: 0 0 clamp(220px, 28%, 260px); }
@media (max-width: 992px){ .related-item { flex: 0 0 45%; } }
@media (max-width: 576px){ .related-item { flex: 0 0 75%; } }
.related-card { background: var(--color-white); border: 1px solid rgba(0,0,0,.05); border-radius: .75rem; box-shadow: 0 4px 10px rgba(44,42,40,.06); position: relative; overflow: hidden; transition: transform .35s ease, box-shadow .35s ease; }
.related-card:hover { transform: translateY(-6px); box-shadow: 0 10px 24px -4px rgba(44,42,40,.18); }
.related-image-wrapper { position: relative; aspect-ratio: 4/3; background: #f3f3f0; overflow: hidden; }
.related-image-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: transform .5s ease; }
.related-card:hover img { transform: scale(1.08); }
.related-overlay { position: absolute; inset: 0; display: flex; align-items: flex-end; justify-content: center; background: linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,.0)); opacity: 0; transition: opacity .4s ease; padding: .75rem; }
.related-card:hover .related-overlay { opacity: 1; }
.price-tag { font-weight: 600; color: var(--color-primary); font-size: .9rem; }
.related-prev, .related-next { width: 38px; height: 38px; display: inline-flex; align-items: center; justify-content: center; }
.mobile-control { position: absolute; top: 40%; transform: translateY(-50%); z-index: 5; display: none; }
@media (max-width: 768px){ .mobile-control { display: inline-flex; } .related-prev.mobile-control { left: .25rem; } .related-next.mobile-control { right: .25rem; } }
.fade-edge { position: absolute; top:0; bottom:0; width:60px; pointer-events:none; z-index:4; }
.fade-edge.left { left:0; background: linear-gradient(to right, var(--color-background), rgba(249,246,241,0)); }
.fade-edge.right { right:0; background: linear-gradient(to left, var(--color-background), rgba(249,246,241,0)); }
.related-carousel-track.grabbing { cursor: grabbing; }
</style>
{% endblock %}