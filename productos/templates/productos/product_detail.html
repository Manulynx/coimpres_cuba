{% extends "coimpres_cuba/base.html" %}
{% load static %}

{% block title %}{{ object.name }} | Coimpres Cuba{% endblock %}

{% block content %}
<div class="container my-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'productos:product_list' %}">Productos</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ object.name }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Galer√≠a Profesional de Medios -->
        <div class="col-md-6 mb-4">
            <div class="product-gallery">
                <!-- Imagen Principal Grande -->
                <div class="main-media-container mb-3">
                    <img id="mainMedia" src="{% if main_image %}{{ main_image.url }}{% elif object.image %}{{ object.image.url }}{% else %}{% static 'img/no-image.jpg' %}{% endif %}" 
                         class="img-fluid rounded shadow-lg" 
                         alt="{{ object.name }}" 
                         style="width: 100%; height: 450px; object-fit: cover; border-radius: 12px;">
                    
                    <!-- Overlay para identificar videos -->
                    <div id="videoOverlay" class="video-play-overlay d-none">
                        <i class="bi bi-play-circle-fill text-white" style="font-size: 4rem; opacity: 0.8;"></i>
                    </div>
                </div>
                
                <!-- Galer√≠a de Thumbnails (Im√°genes + Videos) -->
                <div class="media-thumbnails-container">
                    <div class="thumbnails-scroll-wrapper">
                        <button class="thumbnail-nav-btn prev-btn" id="thumbPrev" aria-label="Anterior">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        
                        <div class="thumbnails-track" id="thumbnailsTrack">
                            <!-- Imagen Principal del Producto (siempre primera) -->
                            {% if object.image %}
                            <div class="thumbnail-item active" data-type="image" data-src="{{ object.image.url }}" data-alt="{{ object.name }}">
                                <img src="{{ object.image.url }}" alt="{{ object.name }}" class="thumbnail-img">
                                <div class="thumbnail-overlay">
                                    <span class="thumbnail-label">Principal</span>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Im√°genes de la Galer√≠a -->
                            {% for image in gallery_images %}
                                {% if not image.is_main or not object.image %}
                                <div class="thumbnail-item" data-type="image" data-src="{{ image.image.url }}" data-alt="{{ image.alt_text|default:object.name }}">
                                    <img src="{{ image.image.url }}" alt="{{ image.alt_text|default:object.name }}" class="thumbnail-img">
                                    {% if image.is_main and not object.image %}
                                    <div class="thumbnail-overlay">
                                        <span class="thumbnail-label">Principal</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% endfor %}
                            
                            <!-- Videos de la Galer√≠a -->
                            {% for video in gallery_videos %}
                            <div class="thumbnail-item" data-type="video" data-src="{{ video.video.url }}" data-alt="{{ video.title|default:'Video del producto' }}">
                                <video class="thumbnail-img" muted preload="metadata">
                                    <source src="{{ video.video.url }}" type="video/mp4">
                                    Tu navegador no soporta el elemento video.
                                </video>
                                <div class="thumbnail-overlay">
                                    <i class="bi bi-play-circle-fill text-white"></i>
                                    {% if video.title %}
                                    <span class="thumbnail-label">{{ video.title|truncatechars:15 }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                            
                            <!-- Video Principal (si existe y no hay videos en galer√≠a) -->
                            {% if object.video and not gallery_videos.exists %}
                            <div class="thumbnail-item" data-type="video" data-src="{{ object.video.url }}" data-alt="Video del producto">
                                <video class="thumbnail-img" muted preload="metadata">
                                    <source src="{{ object.video.url }}" type="video/mp4">
                                    Tu navegador no soporta el elemento video.
                                </video>
                                <div class="thumbnail-overlay">
                                    <i class="bi bi-play-circle-fill text-white"></i>
                                    <span class="thumbnail-label">Video</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <button class="thumbnail-nav-btn next-btn" id="thumbNext" aria-label="Siguiente">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    
                    <!-- Indicador de posici√≥n -->
                    <div class="thumbnails-indicator mt-2">
                        <span id="mediaCounter">1 / <span id="totalMedia">1</span></span>
                    </div>
                </div>
                
                <!-- Modal para vista completa -->
                <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered">
                        <div class="modal-content bg-dark border-0">
                            <div class="modal-header border-0 position-absolute" style="z-index: 1050; top: 15px; right: 15px;">
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body p-0 position-relative">
                                <!-- Contenedor principal del modal -->
                                <div class="modal-media-container">
                                    <!-- Media principal del modal -->
                                    <div class="modal-main-media" id="modalMainMedia">
                                        <!-- El contenido se insertar√° din√°micamente -->
                                    </div>
                                    
                                    <!-- Controles de navegaci√≥n del modal -->
                                    <button class="modal-nav-btn modal-prev" id="modalPrev" aria-label="Anterior">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                    <button class="modal-nav-btn modal-next" id="modalNext" aria-label="Siguiente">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                    
                                    <!-- Informaci√≥n del media -->
                                    <div class="modal-media-info">
                                        <div class="modal-counter">
                                            <span id="modalCounter">1</span> / <span id="modalTotal">1</span>
                                        </div>
                                        <div class="modal-title" id="modalTitle">{{ object.name }}</div>
                                    </div>
                                </div>
                                
                                <!-- Thumbnails del modal -->
                                <div class="modal-thumbnails-section">
                                    <div class="modal-thumbnails-track" id="modalThumbnailsTrack">
                                        <!-- Los thumbnails se insertar√°n din√°micamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <div class="col-md-6">
            <h1 class="mb-3">{{ object.name }}</h1>
            
            {% if object.proveedor %}
            <div class="mb-3">
                <h5>Proveedor:</h5>
                <p>{{ object.proveedor.name }}</p>
                {% if object.proveedor.logo %}
                    <img src="{{ object.proveedor.logo.url }}" alt="{{ object.proveedor.name }}" class="img-fluid" style="max-height: 50px;">
                {% endif %}
            </div>
            {% endif %}
            
            {% if object.price %}
            <div class="mb-3">
                <h3>Precio: ${{ object.price }}</h3>
            </div>
            {% endif %}
            
            {% if object.short_description %}
            <div class="mb-3">
                <h5>Descripci√≥n corta:</h5>
                <p>{{ object.short_description }}</p>
            </div>
            {% endif %}
            
            {% if object.sku %}
            <div class="mb-3">
                <h5>C√≥digo SKU:</h5>
                <p>{{ object.sku }}</p>
            </div>
            {% endif %}
            
            <div class="mb-3">
                <h5>Categor√≠a:</h5>
                <p><span class="category-badge">{{ object.category }}</span></p>
                {% if object.subcategory %}
                    <h5>Subcategor√≠a:</h5>
                    <p><span class="badge bg-secondary">{{ object.subcategory.name }}</span></p>
                {% endif %}
                
                {% if object.status_procedencia %}
                <h5 class="mt-3">Disponibilidad:</h5>
                <p><span class="badge {% if object.status_procedencia.name == 'En stock' %}bg-success{% elif object.status_procedencia.name == 'Por pedido' %}bg-warning text-dark{% else %}bg-info{% endif %}">
                    {{ object.status_procedencia.name }}
                </span></p>
                {% endif %}
            </div>
            
            <!-- Bot√≥n WhatsApp para m√∫ltiples n√∫meros -->
            <div class="mb-4">
                <button onclick="openMultipleWhatsApp()" class="btn btn-whatsapp btn-lg">
                    <i class="bi bi-whatsapp"></i> Contactar Equipo Completo
                    <small class="d-block mt-1" style="font-size: 0.75em; opacity: 0.9;">
                        Abre ambos n√∫meros de contacto
                    </small>
                </button>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="true">Descripci√≥n</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="specs-tab" data-bs-toggle="tab" data-bs-target="#specs" type="button" role="tab" aria-controls="specs" aria-selected="false">Especificaciones</button>
                </li>
            </ul>
            <div class="tab-content p-4 border border-top-0 rounded-bottom" id="productTabsContent">
                <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
                    {% if object.description %}
                        {{ object.description|linebreaks }}
                    {% else %}
                        <p>No hay descripci√≥n detallada disponible para este producto.</p>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="specs" role="tabpanel" aria-labelledby="specs-tab">
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                {% if object.origen %}
                                <tr>
                                    <th scope="row">Pa√≠s de origen</th>
                                    <td>{{ object.origen }}</td>
                                </tr>
                                {% endif %}
                                {% if object.peso %}
                                <tr>
                                    <th scope="row">Peso</th>
                                    <td>{{ object.peso }} kg</td>
                                </tr>
                                {% endif %}
                                {% if object.status_procedencia %}
                                <tr>
                                    <th scope="row">Status de procedencia</th>
                                    <td>{{ object.status_procedencia }}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if object.ficha_tecnica %}
                    <div class="mt-3">
                        <a href="{{ object.ficha_tecnica.url }}" class="btn btn-outline-primary" target="_blank">
                            <i class="bi bi-file-earmark-pdf"></i> Descargar ficha t√©cnica
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Productos relacionados en carrusel -->
    {% if related_products %}
    <div class="related-products-section mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">Productos relacionados</h3>
            <div class="d-none d-md-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm related-prev" aria-label="Anterior">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm related-next" aria-label="Siguiente">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
        <div class="related-carousel-wrapper position-relative">
            <div class="related-carousel-track" data-items="{{ related_products|length }}">
                {% for related_product in related_products %}
                <div class="related-item">
                    <div class="related-card h-100">
                        <div class="related-image-wrapper">
                            {% if related_product.image %}
                                <img src="{{ related_product.image.url }}" alt="{{ related_product.name }}" loading="lazy">
                            {% else %}
                                <img src="{% static 'img/no-image.jpg' %}" alt="Sin imagen" loading="lazy">
                            {% endif %}
                            <div class="related-overlay">
                                <a href="{% url 'productos:product_detail' related_product.slug %}" class="btn btn-sm btn-light fw-semibold shadow-sm">Ver detalle</a>
                            </div>
                        </div>
                        <div class="p-3">
                            <h6 class="mb-1 text-truncate" title="{{ related_product.name }}">{{ related_product.name }}</h6>
                            <p class="small text-muted mb-2 text-truncate" title="{{ related_product.short_description }}">{{ related_product.short_description|default:""|truncatechars:70 }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                {% if related_product.price %}
                                <span class="price-tag">${{ related_product.price }}</span>
                                {% else %}
                                <span class="small text-muted">Consultar</span>
                                {% endif %}
                                <a href="{% url 'productos:product_detail' related_product.slug %}" class="stretched-link d-inline-block ms-2 text-accent small">‚Üí</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- Controles m√≥viles -->
            <button class="btn btn-outline-secondary btn-sm related-prev mobile-control" aria-label="Anterior">
                <i class="bi bi-chevron-left"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm related-next mobile-control" aria-label="Siguiente">
                <i class="bi bi-chevron-right"></i>
            </button>
            <div class="fade-edge left"></div>
            <div class="fade-edge right"></div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/product-gallery.css' %}">
<link rel="stylesheet" href="{% static 'css/related-carousel.css' %}">
<style>
    /* Estilos para bot√≥n WhatsApp m√∫ltiple */
    .btn-whatsapp {
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        border: none;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .btn-whatsapp:hover {
        background: linear-gradient(135deg, #22BE5B 0%, #0F7A6B 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.3);
    }
    
    .btn-whatsapp:active {
        transform: translateY(0);
    }
    
    .btn-whatsapp::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .btn-whatsapp:hover::before {
        left: 100%;
    }
    
    .btn-whatsapp small {
        font-weight: 400;
        letter-spacing: 0.3px;
    }
    
    /* Animaci√≥n de pulso sutil */
    @keyframes whatsappPulse {
        0% {
            box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(37, 211, 102, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
        }
    }
    
    .btn-whatsapp:focus {
        animation: whatsappPulse 1.5s infinite;
    }
    
    /* Responsive para m√≥viles */
    @media (max-width: 768px) {
        .btn-whatsapp {
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/simple-gallery.js' %}"></script>
<script src="{% static 'js/product-gallery.js' %}"></script>
<script src="{% static 'js/related-carousel.js' %}"></script>

<script>
function openMultipleWhatsApp() {
    // Preparar el mensaje con el nombre del producto
    const productName = `{{ object.name|escapejs }}`;
    const message = encodeURIComponent(`Hola, estoy interesado en el producto: ${productName}`);
    
    // Configurar los n√∫meros de contacto
    const contacts = [
        {
            number: '+5399999999',
            name: 'Ventas Cuba',
            icon: 'üè¢'
        },
        {
            number: '+5388888888', 
            name: 'Soporte Cuba',
            icon: 'üéß'
        }
    ];
    
    // Funci√≥n para abrir WhatsApp con efectos visuales
    function openWhatsApp(contact, index) {
        const url = `https://wa.me/${contact.number}?text=${message}`;
        
        // Mostrar notificaci√≥n visual
        showNotification(`${contact.icon} Abriendo ${contact.name}...`, 'info');
        
        // Abrir WhatsApp
        const whatsappWindow = window.open(url, '_blank');
        
        // Verificar si se abri√≥ correctamente
        if (!whatsappWindow) {
            showNotification('‚ö†Ô∏è Por favor, permite ventanas emergentes para contactar por WhatsApp', 'warning');
        }
    }
    
    // Mostrar confirmaci√≥n inicial
    const confirmMessage = `¬øContactar con el equipo completo?\n\nüè¢ Ventas Cuba: ${contacts[0].number}\nüéß Soporte Cuba: ${contacts[1].number}\n\nSe abrir√°n ambos n√∫meros de WhatsApp.`;
    
    if (confirm(confirmMessage)) {
        // Abrir primer contacto inmediatamente
        openWhatsApp(contacts[0], 0);
        
        // Abrir segundo contacto despu√©s de 2 segundos con confirmaci√≥n
        setTimeout(() => {
            const secondConfirm = confirm(`¬øAbrir tambi√©n ${contacts[1].icon} ${contacts[1].name}?\n\n(Se abrir√° en una nueva pesta√±a)`);
            if (secondConfirm) {
                openWhatsApp(contacts[1], 1);
                
                // Mostrar mensaje final
                setTimeout(() => {
                    showNotification('‚úÖ ¬°Ambos contactos de WhatsApp est√°n listos!', 'success');
                }, 500);
            }
        }, 2000);
    }
}

// Funci√≥n para mostrar notificaciones visuales
function showNotification(message, type = 'info') {
    // Crear elemento de notificaci√≥n
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'info' ? 'primary' : type === 'warning' ? 'warning' : 'success'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 8px;
    `;
    
    notification.innerHTML = `
        <strong>${message}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Agregar al body
    document.body.appendChild(notification);
    
    // Auto-remover despu√©s de 4 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 4000);
}

// Mejorar la experiencia con hover en el bot√≥n
document.addEventListener('DOMContentLoaded', function() {
    const whatsappBtn = document.querySelector('button[onclick="openMultipleWhatsApp()"]');
    if (whatsappBtn) {
        whatsappBtn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 6px 20px rgba(37, 211, 102, 0.3)';
        });
        
        whatsappBtn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    }
});
</script>
{% endblock %}