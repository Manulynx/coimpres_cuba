{% extends "coimpres_cuba/base.html" %}
{% load static %}

{% block title %}Productos | Coimpres Cuba{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <aside class="col-lg-3">
      {% include 'productos/partials/filters.html' %}
    </aside>
    <div class="col-lg-9">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Catálogo de Productos</h1>
        <form action="." method="get" class="d-flex">
            <input type="text" name="q" class="form-control me-2" placeholder="Buscar productos..." value="{{ request.GET.q|default:'' }}">
            {% if request.GET.category %}<input type="hidden" name="category" value="{{ request.GET.category }}">{% endif %}
            {% if request.GET.subcategory %}<input type="hidden" name="subcategory" value="{{ request.GET.subcategory }}">{% endif %}
            {% if request.GET.proveedor %}<input type="hidden" name="proveedor" value="{{ request.GET.proveedor }}">{% endif %}
            {% if request.GET.estatus %}<input type="hidden" name="estatus" value="{{ request.GET.estatus }}">{% endif %}
            <button type="submit" class="btn btn-primary">Buscar</button>
        </form>
      </div>

      {% if request.GET.category or request.GET.subcategory or request.GET.proveedor or request.GET.estatus or request.GET.q %}
      <div class="alert alert-info mb-3">
          <h6 class="mb-2">Filtros aplicados:</h6>
          <div class="d-flex flex-wrap gap-2">
              {% if request.GET.q %}<span class="badge bg-primary">Búsqueda: "{{ request.GET.q }}"</span>{% endif %}
              {% if selected_category %}<span class="badge bg-primary">Categoría: {{ selected_category.name }}</span>{% endif %}
              {% if request.GET.subcategory %}<span class="badge bg-primary">Subcategoría: {{ request.GET.subcategory }}</span>{% endif %}
              {% if request.GET.proveedor %}<span class="badge bg-success">Proveedor: {{ request.GET.proveedor }}</span>{% endif %}
              {% if request.GET.estatus %}<span class="badge bg-warning text-dark">Estatus: {{ request.GET.estatus }}</span>{% endif %}
          </div>
      </div>
      {% endif %}

      <div class="d-flex justify-content-between align-items-center mb-3">
          <p class="mb-0 text-muted">
              {% if object_list %}
                  Mostrando {{ object_list|length }} de {{ paginator.count }} productos
              {% else %}
                  No se encontraron productos
              {% endif %}
          </p>
      </div>

      <!-- Grid de productos sin pérdida de espacio -->
      <div class="row g-4 row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4">
        {% if object_list %}
          {% for product in object_list %}
          <div class="col">
            <div class="card h-100 position-relative product-card-item">
              {% if product.get_status_badges %}
              <div class="position-absolute top-0 start-0 p-2" style="z-index:10;">
                {% for badge in product.get_status_badges %}
                  <span class="badge {{ badge.class }} me-1 mb-1">{{ badge.text }}</span>
                {% endfor %}
              </div>
              {% endif %}

              {% if product.image %}
                <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}" style="height:190px;object-fit:cover;">
              {% else %}
                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height:190px;">
                  <i class="bi bi-image text-muted" style="font-size:3rem;"></i>
                </div>
              {% endif %}

              <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ product.name }}</h5>

                {% if product.proveedor %}
                <div class="d-flex align-items-center mb-2">
                  {% if product.proveedor.logo %}
                  <img src="{{ product.proveedor.logo.url }}" alt="{{ product.proveedor.name }}" width="20" height="20" class="me-2" style="border-radius:3px;">
                  {% endif %}
                  <small class="text-muted">{{ product.proveedor.name }}</small>
                </div>
                {% endif %}

                <div class="mb-2">
                  {% if product.category %}<span class="badge bg-primary me-1">{{ product.category.name }}</span>{% endif %}
                  {% if product.subcategory %}<span class="badge bg-secondary">{{ product.subcategory.name }}</span>{% endif %}
                </div>

                {% if product.estatus %}
                <div class="mb-2">
                  <span class="badge bg-warning text-dark">{{ product.estatus.name }}</span>
                </div>
                {% endif %}

                <p class="card-text flex-grow-1">{{ product.short_description|truncatechars:100 }}</p>

                <div class="mt-auto">
                  {% if product.price %}<p class="card-text fw-bold text-success mb-2">${{ product.price }}</p>{% endif %}
                  {% if product.sku %}<small class="text-muted d-block mb-2">SKU: {{ product.sku }}</small>{% endif %}
                  <a href="{% url 'productos:product_detail' product.slug %}" class="btn btn-primary w-100">Ver detalle</a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="col-12">
            <div class="alert alert-info">No hay productos disponibles en este momento.</div>
          </div>
        {% endif %}
      </div>

      {% if is_paginated %}
      <nav aria-label="Page navigation" class="mt-4">
          <ul class="pagination justify-content-center">
              {% if page_obj.has_previous %}
                  <li class="page-item">
                      <a class="page-link" href="?page=1">&laquo; Primera</a>
                  </li>
                  <li class="page-item">
                      <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
                  </li>
              {% endif %}

              {% for num in page_obj.paginator.page_range %}
                  {% if page_obj.number == num %}
                      <li class="page-item active">
                          <span class="page-link">{{ num }} <span class="sr-only">(current)</span></span>
                      </li>
                  {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                      <li class="page-item">
                          <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                      </li>
                  {% endif %}
              {% endfor %}

              {% if page_obj.has_next %}
                  <li class="page-item">
                      <a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a>
                  </li>
                  <li class="page-item">
                      <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Última &raquo;</a>
                  </li>
              {% endif %}
          </ul>
      </nav>
      {% endif %}
    </div>
  </div>
</div>
{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/filters-panel.js' %}"></script>
{% endblock %}
{% endblock %}